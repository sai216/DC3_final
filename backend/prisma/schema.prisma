// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProjectType {
  creative
  fullstack
  web3
  ai_automation
}

enum Urgency {
  standard
  urgent
  critical
}

enum ProjectStatus {
  initiated
  assessment_complete
  quote_generated
  strategy_call_booked
  quote_accepted
  in_progress
  completed
}

enum QuoteStatus {
  pending
  sent
  accepted
  declined
  expired
}

enum CallStatus {
  scheduled
  confirmed
  completed
  cancelled
  no_show
}

enum OtpType {
  email
  whatsapp
  phone
}

model User {
  id               String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email            String?              @unique @db.VarChar(255)
  emailVerified    Boolean              @default(false) @map("email_verified")
  walletAddress    String?              @unique @map("wallet_address") @db.VarChar(255)
  privyUserId      String?              @unique @map("privy_user_id") @db.VarChar(255)
  phoneE164        String?              @map("phone_e164") @db.VarChar(20)
  phoneVerified    Boolean              @default(false) @map("phone_verified")
  whatsappVerified Boolean              @default(false) @map("whatsapp_verified")
  businessName     String?              @map("business_name") @db.VarChar(255)
  authStage        Int                  @default(0) @map("auth_stage")
  createdAt        DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastLogin        DateTime?            @map("last_login") @db.Timestamptz(6)
  metadata         Json                 @default("{}") @db.JsonB
  projects         ProjectAssessment[]
  quotes           ProjectQuote[]
  strategyCalls    StrategyCall[]
  auditLogs        AuditLog[]
  otpVerifications OtpVerification[]

  @@index([email])
  @@index([walletAddress], name: "idx_users_wallet")
  @@index([privyUserId], name: "idx_users_privy_id")
  @@index([phoneE164], name: "idx_users_phone")
  @@index([authStage], name: "idx_users_auth_stage")
  @@map("users")
}

model ProjectAssessment {
  id                 String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String         @map("user_id") @db.Uuid
  projectName        String         @map("project_name") @db.VarChar(255)
  projectType        ProjectType    @map("project_type")
  projectDescription String?        @map("project_description") @db.Text
  projectScope       Json?          @map("project_scope") @db.JsonB
  budgetRange        String?        @map("budget_range") @db.VarChar(50)
  urgency            Urgency?
  complexityScore    Decimal?       @map("complexity_score") @db.Decimal(3, 2)
  status             ProjectStatus  @default(initiated)
  createdAt          DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  quotes             ProjectQuote[]
  strategyCalls      StrategyCall[]

  @@index([userId], name: "idx_projects_user")
  @@index([status], name: "idx_projects_status")
  @@index([projectType], name: "idx_projects_type")
  @@map("project_assessments")
}

model ProjectQuote {
  id                      String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId               String       @map("project_id") @db.Uuid
  userId                  String       @map("user_id") @db.Uuid
  
  // Pricing breakdown
  baseRate                Decimal      @map("base_rate") @db.Decimal(10, 2)
  complexityAdjustment    Decimal      @default(0) @map("complexity_adjustment") @db.Decimal(10, 2)
  urgencyAdjustment       Decimal      @default(0) @map("urgency_adjustment") @db.Decimal(10, 2)
  totalEstimate           Decimal      @map("total_estimate") @db.Decimal(10, 2)
  notToExceed             Decimal      @map("not_to_exceed") @db.Decimal(10, 2)
  
  // Timeline
  estimatedTimelineWeeks  Int?         @map("estimated_timeline_weeks")
  deliveryDate            DateTime?    @map("delivery_date") @db.Date
  
  // Terms
  paymentStructure        Json?        @map("payment_structure") @db.JsonB
  termsAccepted           Boolean      @default(false) @map("terms_accepted")
  acceptedAt              DateTime?    @map("accepted_at") @db.Timestamptz(6)
  
  // Validity
  validUntil              DateTime     @map("valid_until") @db.Date
  status                  QuoteStatus  @default(pending)
  
  createdAt               DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  metadata                Json         @default("{}") @db.JsonB
  
  project                 ProjectAssessment @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user                    User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId], name: "idx_quotes_project")
  @@index([userId], name: "idx_quotes_user")
  @@index([status], name: "idx_quotes_status")
  @@map("project_quotes")
}

model StrategyCall {
  id              String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String             @map("user_id") @db.Uuid
  projectId       String?            @map("project_id") @db.Uuid
  
  googleEventId   String?            @unique @map("google_event_id") @db.VarChar(255)
  scheduledAt     DateTime           @map("scheduled_at") @db.Timestamptz(6)
  durationMinutes Int                @default(60) @map("duration_minutes")
  meetLink        String?            @map("meet_link") @db.VarChar(500)
  
  status          CallStatus         @default(scheduled)
  notes           String?            @db.Text
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  project         ProjectAssessment? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId], name: "idx_strategy_calls_user")
  @@index([scheduledAt], name: "idx_strategy_calls_scheduled")
  @@map("strategy_calls")
}

model AuditLog {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String?   @map("user_id") @db.Uuid
  action         String    @db.VarChar(100)
  entityType     String?   @map("entity_type") @db.VarChar(50)
  entityId       String?   @map("entity_id") @db.Uuid
  ipAddress      String?   @map("ip_address") @db.Inet
  userAgent      String?   @map("user_agent") @db.Text
  requestData    Json?     @map("request_data") @db.JsonB
  responseStatus Int?      @map("response_status")
  loggedAt       DateTime  @default(now()) @map("logged_at") @db.Timestamptz(6)
  
  user           User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId], name: "idx_audit_user")
  @@index([action], name: "idx_audit_action")
  @@index([loggedAt(sort: Desc)], name: "idx_audit_logged")
  @@map("audit_logs")
}

model OtpVerification {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid
  otpType     OtpType  @map("otp_type")
  otpCode     String   @map("otp_code") @db.VarChar(6)
  destination String   @db.VarChar(255)
  verified    Boolean  @default(false)
  expiresAt   DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], name: "idx_otp_user")
  @@index([destination], name: "idx_otp_destination")
  @@index([expiresAt], name: "idx_otp_expires")
  @@map("otp_verifications")
}

enum AuditStatus {
  draft
  manifest_submitted
  identity_verified
  otp_verified
  meeting_scheduled
  submitted
  under_review
  approved
  rejected
}

model UploadedFile {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String          @map("user_id") @db.Uuid
  fileName        String          @map("file_name") @db.VarChar(255)
  originalName    String          @map("original_name") @db.VarChar(255)
  mimeType        String          @map("mime_type") @db.VarChar(100)
  fileSize        Int             @map("file_size")
  storageUrl      String          @map("storage_url") @db.Text
  signedUrl       String?         @map("signed_url") @db.Text
  signedUrlExpiry DateTime?       @map("signed_url_expiry") @db.Timestamptz(6)
  bucketPath      String          @map("bucket_path") @db.Text
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  
  manifestFiles   AuditManifestFile[]

  @@index([userId], name: "idx_uploaded_files_user")
  @@index([createdAt], name: "idx_uploaded_files_created")
  @@map("uploaded_files")
}

model AuditManifest {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String              @map("user_id") @db.Uuid
  loomUrl         String?             @map("loom_url") @db.Text
  docsUrl         String?             @map("docs_url") @db.Text
  createdAt       DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  files           AuditManifestFile[]
  submissions     AuditSubmission[]

  @@index([userId], name: "idx_audit_manifest_user")
  @@map("audit_manifests")
}

model AuditManifestFile {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  manifestId      String          @map("manifest_id") @db.Uuid
  fileId          String          @map("file_id") @db.Uuid
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  
  manifest        AuditManifest   @relation(fields: [manifestId], references: [id], onDelete: Cascade)
  file            UploadedFile    @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([manifestId, fileId])
  @@index([manifestId], name: "idx_manifest_files_manifest")
  @@index([fileId], name: "idx_manifest_files_file")
  @@map("audit_manifest_files")
}

model AuditIdentity {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String          @map("user_id") @db.Uuid
  linkedinUrl     String?         @map("linkedin_url") @db.Text
  businessEmail   String?         @map("business_email") @db.VarChar(255)
  whatsappNumber  String?         @map("whatsapp_number") @db.VarChar(20)
  verified        Boolean         @default(false)
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  submissions     AuditSubmission[]

  @@index([userId], name: "idx_audit_identity_user")
  @@index([businessEmail], name: "idx_audit_identity_email")
  @@map("audit_identities")
}

model AuditSubmission {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String          @map("user_id") @db.Uuid
  manifestId      String?         @map("manifest_id") @db.Uuid
  identityId      String?         @map("identity_id") @db.Uuid
  meetingId       String?         @map("meeting_id") @db.Uuid
  goals           Json?           @db.JsonB
  status          AuditStatus     @default(draft)
  phoneVerified   Boolean         @default(false) @map("phone_verified")
  googleMeetLink  String?         @map("google_meet_link") @db.Text
  scheduledDate   DateTime?       @map("scheduled_date") @db.Timestamptz(6)
  submittedAt     DateTime?       @map("submitted_at") @db.Timestamptz(6)
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  metadata        Json            @default("{}") @db.JsonB
  
  manifest        AuditManifest?  @relation(fields: [manifestId], references: [id], onDelete: SetNull)
  identity        AuditIdentity?  @relation(fields: [identityId], references: [id], onDelete: SetNull)

  @@index([userId], name: "idx_audit_submission_user")
  @@index([status], name: "idx_audit_submission_status")
  @@index([createdAt], name: "idx_audit_submission_created")
  @@map("audit_submissions")
}

// ==========================================
// RAG + AI + Pricing Models
// ==========================================

enum DocumentType {
  pdf
  terms
  bundle
  general
}

enum MessageRole {
  user
  assistant
  system
}

model KnowledgeBase {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentType    DocumentType    @map("document_type")
  content         String          @db.Text
  embedding       Json?           @db.JsonB
  metadata        Json            @default("{}") @db.JsonB
  title           String?         @db.VarChar(255)
  category        String?         @db.VarChar(100)
  version         String?         @db.VarChar(50)
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  @@index([documentType], name: "idx_kb_doc_type")
  @@index([category], name: "idx_kb_category")
  @@map("knowledge_base")
}

model Conversation {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String          @map("user_id") @db.Uuid
  initialContext  Json?           @map("initial_context") @db.JsonB
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  messages        Message[]
  
  @@index([userId], name: "idx_conversation_user")
  @@index([createdAt], name: "idx_conversation_created")
  @@map("conversations")
}

model Message {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversationId    String          @map("conversation_id") @db.Uuid
  role              MessageRole
  content           String          @db.Text
  thoughtSignature  Json?           @map("thought_signature") @db.JsonB
  timestamp         DateTime        @default(now()) @db.Timestamptz(6)
  
  conversation      Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId], name: "idx_message_conversation")
  @@index([timestamp], name: "idx_message_timestamp")
  @@map("messages")
}

model RevenueCategory {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String          @unique @db.VarChar(100)
  code            String          @unique @db.VarChar(50)
  description     String?         @db.Text
  metadata        Json            @default("{}") @db.JsonB
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  
  pricing         BasePricing[]
  
  @@map("revenue_categories")
}

model CompanyScale {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String          @unique @db.VarChar(100)
  code            String          @unique @db.VarChar(50)
  revenueMin      Decimal?        @map("revenue_min") @db.Decimal(15, 2)
  revenueMax      Decimal?        @map("revenue_max") @db.Decimal(15, 2)
  multiplier      Decimal         @default(1.0) @db.Decimal(5, 2)
  description     String?         @db.Text
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  
  pricing         BasePricing[]
  
  @@map("company_scales")
}

model ComplexityTier {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rating          Int             @unique
  name            String          @db.VarChar(100)
  description     String?         @db.Text
  adjustmentMultiplier Decimal    @default(1.0) @map("adjustment_multiplier") @db.Decimal(5, 2)
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  
  @@map("complexity_tiers")
}

model BasePricing {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bundleId            String          @map("bundle_id") @db.VarChar(100)
  bundleName          String          @map("bundle_name") @db.VarChar(255)
  revenueCategoryId   String          @map("revenue_category_id") @db.Uuid
  companyScaleId      String          @map("company_scale_id") @db.Uuid
  basePrice           Decimal         @map("base_price") @db.Decimal(10, 2)
  description         String?         @db.Text
  metadata            Json            @default("{}") @db.JsonB
  createdAt           DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  revenueCategory     RevenueCategory @relation(fields: [revenueCategoryId], references: [id], onDelete: Cascade)
  companyScale        CompanyScale    @relation(fields: [companyScaleId], references: [id], onDelete: Cascade)
  
  @@unique([bundleId, revenueCategoryId, companyScaleId])
  @@index([bundleId], name: "idx_base_pricing_bundle")
  @@index([revenueCategoryId], name: "idx_base_pricing_category")
  @@index([companyScaleId], name: "idx_base_pricing_scale")
  @@map("base_pricing")
}
